<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <title>Lottery Lobby</title>
    <style>
        body { font-family: sans-serif; background-color: #1c1c1e; color: #fff; padding: 20px; text-align: center; }
        .hidden { display: none; }
        #lobby, #game-board { max-width: 600px; margin: 0 auto; }
        .round-card { background-color: #3a3a3c; border-radius: 12px; padding: 20px; margin-bottom: 15px; cursor: pointer; transition: transform 0.2s; }
        .round-card:hover { transform: scale(1.03); }
        h1, h2 { color: #f2f2f7; }
        .round-card h2 { margin: 0 0 10px 0; }
        .round-card p { margin: 5px 0 0 0; color: #c7c7cc; }
        
        /* --- NEW STYLES FOR WINNER HISTORY --- */
        #winner-history { margin-top: 40px; }
        .draw-card { background-color: #2c2c2e; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .draw-card h3 { margin: 0 0 15px 0; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .winner-entry { display: flex; justify-content: space-between; padding: 5px 0; }
        .winner-entry .rank { font-weight: bold; }
        
        /* --- Grid styles (unchanged) --- */
        #grid-container { display: grid; grid-template-columns: repeat(10, 1fr); gap: 8px; margin-top: 20px; }
        .grid-number { aspect-ratio: 1 / 1; display: flex; justify-content: center; align-items: center; font-weight: bold; border-radius: 8px; cursor: pointer; }
        .status-available { background-color: #34c759; }
        .status-pending { background-color: #ff9500; cursor: not-allowed; }
        .status-confirmed { background-color: #5856d6; cursor: not-allowed; }
        #message-area { margin-top: 20px; font-size: 1.2em; min-height: 2em; }
    </style>
</head>
<body>

    <div id="lobby">
        <h1>Open Lottery Rounds</h1>
        <div id="rounds-list"></div>
        <div id="winner-history">
            <h2>üèÜ Recent Draws</h2>
            <div id="winner-history-list"></div>
        </div>
    </div>

    <div id="game-board" class="hidden">
        <!-- Game board content is here -->
        <h1 id="round-name"></h1>
        <div id="grid-container"></div>
        <div id="message-area">Loading game grid...</div>
    </div>

    <script>
        const API_URL = 'https://telegram-gaming-platform.onrender.com'; // Use your live URL
        
        window.onload = function() { /* ... unchanged ... */ };
        function startApp() { /* ... unchanged ... */ }
        
        // --- THIS IS THE NEW WINNERS FUNCTION ---
        async function loadWinnerHistory() {
            const historyList = document.getElementById('winner-history-list');
            try {
                const response = await fetch(`${API_URL}/api/winners/history`);
                if (!response.ok) throw new Error('Network error');
                const history = await response.json();
                
                historyList.innerHTML = '';
                if (history.length === 0) {
                    historyList.innerHTML = '<p>No completed draws yet.</p>';
                    return;
                }

                history.forEach(draw => {
                    const drawCard = document.createElement('div');
                    drawCard.className = 'draw-card';
                    
                    let winnersHtml = '';
                    draw.winners.forEach(winner => {
                        winnersHtml += `
                            <div class="winner-entry">
                                <span class="rank">Rank ${winner.prize_tier}</span>
                                <span>${winner.user_name}</span>
                                <span>${winner.prize_amount.toFixed(2)} Birr</span>
                            </div>
                        `;
                    });

                    drawCard.innerHTML = `<h3>${draw.round_name}</h3>${winnersHtml}`;
                    historyList.appendChild(drawCard);
                });

            } catch (error) {
                console.error("Failed to load winner history:", error);
                historyList.innerHTML = '<p>Could not load winner history.</p>';
            }
        }

        // --- All other functions are the same ---
        // I will paste them below to ensure a complete file.
        window.onload = function() {
            try {
                const tg = window.Telegram.WebApp; tg.ready(); window.tgUser = tg.initDataUnsafe.user;
            } catch (error) { console.error("Could not init TG Web App."); }
            startApp();
        };
        function startApp() {
            const lobbyView = document.getElementById('lobby'); const gameView = document.getElementById('game-board');
            const params = new URLSearchParams(window.location.search); const currentRoundId = params.get('round');
            if (currentRoundId) {
                lobbyView.classList.add('hidden'); gameView.classList.remove('hidden'); loadGameGrid(currentRoundId);
            } else {
                loadLobby();
                loadWinnerHistory(); // Replaced loadRecentWinners with this
            }
        }
        async function loadLobby() {
            const roundsList = document.getElementById('rounds-list');
            try {
                const response = await fetch(`${API_URL}/api/rounds/open`);
                if (!response.ok) throw new Error('Network error');
                const rounds = await response.json();
                roundsList.innerHTML = '';
                if (rounds.length === 0) { roundsList.innerHTML = '<p>No open rounds.</p>'; return; }
                rounds.forEach(round => {
                    const card = document.createElement('div'); card.className = 'round-card';
                    card.innerHTML = `<h2>${round.name}</h2><p>${round.price} Birr Entry</p><p>${round.confirmed_players} / ${round.grid_size} Slots Filled</p>`;
                    card.onclick = () => { window.location.href = `?round=${round.id}`; };
                    roundsList.appendChild(card);
                });
            } catch (error) { console.error("Lobby Error:", error); roundsList.innerHTML = '<p>Could not load rounds.</p>'; }
        }
        async function loadGameGrid(roundId) {
            const roundNameHeader = document.getElementById('round-name'), gridContainer = document.getElementById('grid-container'), messageArea = document.getElementById('message-area');
            try {
                const response = await fetch(`${API_URL}/api/game_state/${roundId}`);
                if (!response.ok) throw new Error('Network error');
                const state = await response.json();
                roundNameHeader.textContent = state.round_name; gridContainer.innerHTML = '';
                const selections = state.selections || {};
                for (let i = 1; i <= state.grid_size; i++) {
                    const numberDiv = document.createElement('div'); numberDiv.className = 'grid-number'; numberDiv.textContent = i;
                    const selection = selections[i];
                    if (selection) { numberDiv.classList.add(`status-${selection.status}`); numberDiv.title = `Selected by: ${selection.user_name}`; } 
                    else { numberDiv.classList.add('status-available'); numberDiv.onclick = () => handleNumberClick(roundId, i); }
                    gridContainer.appendChild(numberDiv);
                }
                messageArea.textContent = 'Select a number.';
            } catch (error) { console.error("Game Grid Error:", error); messageArea.textContent = 'Could not load grid.'; }
        }
        async function handleNumberClick(roundId, number) {
            let userId, userName;
            if (window.tgUser && window.tgUser.id) {
                userId = window.tgUser.id;
                userName = window.tgUser.username ? `@${window.tgUser.username}` : `${window.tgUser.first_name} ${window.tgUser.last_name || ''}`.trim();
                if (!confirm(`Confirm selection of number ${number} as ${userName}?`)) return;
            } else {
                userName = prompt(`You selected number ${number}. Please enter your name:`);
                if (!userName || !userName.trim()) return;
                userId = 'user_browser_' + Math.random().toString(36).substr(2, 9);
            }
            await submitSelection(roundId, number, userId, userName);
        }
        async function submitSelection(roundId, number, userId, userName) {
            const messageArea = document.getElementById('message-area');
            try {
                const response = await fetch(`${API_URL}/api/select_number`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ round_id: roundId, number: number, user_id: userId, user_name: userName })
                });
                if (!response.ok) { const err = await response.json(); throw new Error(err.error); }
                const result = await response.json();
                messageArea.textContent = result.message;
                loadGameGrid(roundId);
            } catch (error) { console.error("Selection Error:", error); messageArea.textContent = `Error: ${error.message}`; }
        }
    </script>
</body>
</html>